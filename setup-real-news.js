const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function setupRealNews() {
  try {
    console.log('ğŸ”— Conectando a Supabase...');
    
    // Verificar conexiÃ³n
    const { data: connectionTest, error: connectionError } = await supabase
      .from('news')
      .select('count')
      .limit(1);
    
    if (connectionError) {
      console.log('âŒ Error conectando a Supabase:', connectionError.message);
      console.log('ğŸ“‹ Creando estructura bÃ¡sica...');
      
      // Crear tabla news bÃ¡sica si no existe
      const { error: createError } = await supabase.rpc('exec_sql', {
        sql_query: `
          CREATE TABLE IF NOT EXISTS news (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            url TEXT NOT NULL UNIQUE,
            source TEXT NOT NULL,
            domain TEXT NOT NULL,
            author TEXT,
            published_at TIMESTAMP WITH TIME ZONE,
            scraped_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            category TEXT,
            tags TEXT[],
            image_url TEXT,
            summary TEXT,
            word_count INTEGER,
            reading_time INTEGER,
            language TEXT DEFAULT 'es',
            status TEXT DEFAULT 'published',
            priority INTEGER DEFAULT 1,
            is_selected BOOLEAN DEFAULT FALSE,
            selected_by TEXT[],
            selection_date TIMESTAMP WITH TIME ZONE,
            humanized_content TEXT,
            humanization_tone TEXT,
            humanization_style TEXT,
            humanization_complexity TEXT,
            humanization_date TIMESTAMP WITH TIME ZONE,
            humanization_cost DECIMAL(10, 6),
            humanization_tokens INTEGER,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
          );
          
          CREATE TABLE IF NOT EXISTS news_selections (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            news_id BIGINT REFERENCES news(id) ON DELETE CASCADE,
            user_id TEXT NOT NULL,
            selection_type TEXT DEFAULT 'manual',
            selected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            UNIQUE(news_id, user_id)
          );
          
          CREATE INDEX IF NOT EXISTS idx_news_published_at ON news(published_at DESC);
          CREATE INDEX IF NOT EXISTS idx_news_status ON news(status);
          CREATE INDEX IF NOT EXISTS idx_news_category ON news(category);
          CREATE INDEX IF NOT EXISTS idx_news_selections_user_id ON news_selections(user_id);
        `
      });
      
      if (createError) {
        console.log('âš ï¸ No se pudo crear la estructura:', createError.message);
      } else {
        console.log('âœ… Estructura creada');
      }
    } else {
      console.log('âœ… ConexiÃ³n a Supabase exitosa');
    }
    
    // Insertar noticias de prueba
    console.log('ğŸ“° Insertando noticias de prueba...');
    
    const testNews = [
      {
        title: "EconomÃ­a chilena muestra signos de recuperaciÃ³n en tercer trimestre",
        content: "SegÃºn Ãºltimos reportes del Banco Central, la economÃ­a chilena ha mostrado indicadores positivos de recuperaciÃ³n durante el tercer trimestre del aÃ±o. El PIB creciÃ³ un 2.3% respecto al trimestre anterior, superando las expectativas de los analistas. Este crecimiento se atribuye principalmente al repunte en el sector minero y al aumento del consumo interno. Los expertos mantienen una visiÃ³n cautelosamente optimista para los prÃ³ximos meses.",
        url: "https://www.emol.com/economia/noticias/2025/11/05/recuperacion-economia.html",
        source: "El Mercurio",
        domain: "emol.com",
        author: "Juan PÃ©rez MartÃ­nez",
        published_at: "2025-11-05T12:00:00Z",
        category: "EconomÃ­a",
        tags: ["economÃ­a", "bc", "recuperaciÃ³n", "pib"],
        summary: "La economÃ­a chilena muestra signos de recuperaciÃ³n segÃºn el Banco Central.",
        word_count: 450,
        reading_time: 2,
        language: "es",
        status: "published",
        priority: 2
      },
      {
        title: "Nuevas tecnologÃ­as transforman el sector minero nacional",
        content: "La industria minera chilena estÃ¡ adoptando tecnologÃ­as de automatizaciÃ³n e inteligencia artificial para mejorar la productividad y seguridad. Empresas como Codelco y BHP estÃ¡n implementando sistemas autÃ³nomos de transporte y monitoreo predictivo de equipos. Estas innovaciones no solo aumentan la eficiencia operativa, sino que tambiÃ©n reducen el impacto ambiental y mejoran las condiciones laborales de los trabajadores.",
        url: "https://www.latercera.com/tecnologia/mineria-automatizacion-2025.html",
        source: "La Tercera",
        domain: "latercera.com",
        author: "MarÃ­a GonzÃ¡lez LÃ³pez",
        published_at: "2025-11-05T10:15:00Z",
        category: "TecnologÃ­a",
        tags: ["tecnologÃ­a", "minerÃ­a", "ia", "automatizaciÃ³n"],
        summary: "El sector minero chileno adopta nuevas tecnologÃ­as para mejorar procesos.",
        word_count: 380,
        reading_time: 2,
        language: "es",
        status: "published",
        priority: 1,
        humanized_content: "La industria minera de Chile estÃ¡ experimentando una transformaciÃ³n digital significativa, con la incorporaciÃ³n de tecnologÃ­as de vanguardia que estÃ¡n revolucionando la forma en que se opera. La automatizaciÃ³n y la inteligencia artificial estÃ¡n permitiendo optimizar procesos, mejorar la seguridad y reducir el impacto ambiental.",
        humanization_tone: "professional",
        humanization_style: "detailed",
        humanization_complexity: "intermediate",
        humanization_date: "2025-11-05T11:00:00Z",
        humanization_cost: 0.002,
        humanization_tokens: 150
      },
      {
        title: "SelecciÃ³n chilena prepara prÃ³ximo partido clasificatorio",
        content: "La selecciÃ³n nacional de fÃºtbol se prepara para enfrentar un partido crucial en las clasificatorias al mundial. El tÃ©cnico Eduardo Berizzo ha convocado a los mejores jugadores disponibles y estÃ¡ trabajando en tÃ¡cticas especÃ­ficas para contrarrestar el estilo de juego del rival. El partido se jugarÃ¡ en el Estadio Nacional y se espera una asistencia masiva de hinchas.",
        url: "https://www.biobiochile.cl/deportes/seleccion-chilena-clasificatorio-2025.html",
        source: "BiobÃ­o Chile",
        domain: "biobiochile.cl",
        author: "Carlos RodrÃ­guez Silva",
        published_at: "2025-11-05T09:30:00Z",
        category: "Deportes",
        tags: ["fÃºtbol", "selecciÃ³n", "clasificatorias", "mundial"],
        summary: "La Roja se prepara para un partido decisivo en las clasificatorias.",
        word_count: 320,
        reading_time: 1,
        language: "es",
        status: "published",
        priority: 3
      },
      {
        title: "Gobierno anuncia nuevas medidas de apoyo a pymes",
        content: "El presidente Gabriel Boric anunciÃ³ hoy un conjunto de medidas destinadas a apoyar a las pequeÃ±as y medianas empresas afectadas por la crisis econÃ³mica. Las iniciativas incluyen lÃ­neas de crÃ©dito con tasas preferenciales, programas de capacitaciÃ³n y simplificaciÃ³n de trÃ¡mites burocrÃ¡ticos. El plan contempla una inversiÃ³n inicial de 500 mil millones de pesos.",
        url: "https://www.df.cl/economia/politica/gobierno-pymes-apoyo-2025.html",
        source: "Diario Financiero",
        domain: "df.cl",
        author: "Ana MarÃ­a Torres",
        published_at: "2025-11-05T08:45:00Z",
        category: "PolÃ­tica",
        tags: ["gobierno", "pymes", "economÃ­a", "apoyo"],
        summary: "Nuevo plan de gobierno para apoyar a pequeÃ±as y medianas empresas.",
        word_count: 280,
        reading_time: 1,
        language: "es",
        status: "published",
        priority: 2
      },
      {
        title: "Descubren nueva especie de mariposa en la Patagonia",
        content: "CientÃ­ficos chilenos han descubierto una nueva especie de mariposa endÃ©mica de la regiÃ³n patagÃ³nica. El insecto, bautizado como 'Morpho patagonica chilensis', presenta caracterÃ­sticas Ãºnicas en sus alas con tonalidades azuladas que no se habÃ­an visto antes en la regiÃ³n. El descubrimiento fue publicado en la revista internacional Nature.",
        url: "https://www.latercera.com/la-tercera-domo/mariposa-patagonia-descubrimiento.html",
        source: "La Tercera",
        domain: "latercera.com",
        author: "Dr. Roberto Fuentes",
        published_at: "2025-11-04T16:20:00Z",
        category: "Ciencia",
        tags: ["ciencia", "naturaleza", "descubrimiento", "patagonia"],
        summary: "Nueva especie de mariposa descubierta en la Patagonia chilena.",
        word_count: 420,
        reading_time: 2,
        language: "es",
        status: "published",
        priority: 1
      }
    ];
    
    for (const news of testNews) {
      const { data, error } = await supabase
        .from('news')
        .upsert(news, { onConflict: 'url' })
        .select();
      
      if (error) {
        console.log(`âŒ Error insertando noticia "${news.title.substring(0, 30)}...":`, error.message);
      } else {
        console.log(`âœ… Noticia insertada: "${news.title.substring(0, 30)}..."`);
      }
    }
    
    // Verificar resultado final
    const { data: finalNews, error: finalError } = await supabase
      .from('news')
      .select('id, title, source, category')
      .order('created_at', { ascending: false })
      .limit(10);
    
    if (finalError) {
      console.log('âŒ Error verificando noticias finales:', finalError.message);
    } else {
      console.log(`ğŸ‰ Setup completado! Hay ${finalNews.length} noticias en la base de datos:`);
      finalNews.forEach((news, index) => {
        console.log(`   ${index + 1}. ${news.title} (${news.source} - ${news.category})`);
      });
    }
    
    console.log('\nğŸš€ La aplicaciÃ³n ahora estÃ¡ lista para operar 100% real con Supabase');
    console.log('ğŸ“± Visita http://localhost:3005/news para ver el sistema de noticias');
    
  } catch (error) {
    console.error('âŒ Error en setup:', error.message);
  }
}

setupRealNews();