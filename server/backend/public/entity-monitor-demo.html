<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Entidades - Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        textarea { min-height: 80px; resize: vertical; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .entities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .entity-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; }
        .entity-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .entity-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .entity-name { font-size: 18px; font-weight: 600; color: #111; }
        .entity-type { display: inline-block; padding: 4px 8px; background: #e0e7ff; color: #3730a3; border-radius: 4px; font-size: 12px; }
        .entity-stats { display: flex; gap: 15px; margin-top: 10px; font-size: 14px; color: #666; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .sentiment-score { font-size: 24px; font-weight: 700; text-align: center; margin: 20px 0; }
        .sentiment-positive { color: #059669; }
        .sentiment-negative { color: #dc2626; }
        .sentiment-neutral { color: #6b7280; }
        .mentions-list { max-height: 400px; overflow-y: auto; }
        .mention-item { padding: 15px; border-bottom: 1px solid #e5e7eb; }
        .mention-item:last-child { border-bottom: none; }
        .mention-context { background: #f9fafb; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 14px; line-height: 1.6; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-positive { background: #d1fae5; color: #065f46; }
        .badge-negative { background: #fee2e2; color: #991b1b; }
        .badge-neutral { background: #f3f4f6; color: #374151; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Monitor de Entidades</h1>
        
        <div id="alerts"></div>
        
        <!-- Formulario para crear entidad -->
        <div class="card">
            <h2>Crear Nueva Entidad</h2>
            <form id="createForm">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="name" required placeholder="Ej: Antonio Cast">
                </div>
                
                <div class="form-group">
                    <label>Aliases (separados por coma)</label>
                    <textarea id="aliases" placeholder="Ej: A. Cast, Antonio C., Cast"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="type">
                        <option value="PERSON">Persona</option>
                        <option value="COMPANY">Empresa</option>
                        <option value="TOPIC">Tema</option>
                        <option value="EVENT">Evento</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="description" placeholder="Descripci√≥n opcional"></textarea>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="case_sensitive">
                    <label for="case_sensitive">Sensible a may√∫sculas</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="exact_match">
                    <label for="exact_match">Coincidencia exacta</label>
                </div>
                
                <button type="submit">Crear Entidad</button>
            </form>
        </div>
        
        <!-- Lista de entidades -->
        <div class="card">
            <h2>Mis Entidades</h2>
            <div id="entitiesList" class="entities-grid">
                <div class="loading">Cargando entidades...</div>
            </div>
        </div>
        
        <!-- Detalles de entidad (oculto por defecto) -->
        <div id="entityDetails" class="card" style="display: none;">
            <h2 id="detailsTitle">Detalles de Entidad</h2>
            <div id="detailsContent"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentEntity = null;

        // Obtener token
        function getToken() {
            return localStorage.getItem('token');
        }

        // Fetch autenticado
        async function authenticatedFetch(url, options = {}) {
            const token = getToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }

            return response;
        }

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Crear entidad
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const aliases = document.getElementById('aliases').value
                .split(',')
                .map(a => a.trim())
                .filter(a => a);
            
            const data = {
                name: document.getElementById('name').value,
                aliases,
                type: document.getElementById('type').value,
                description: document.getElementById('description').value,
                case_sensitive: document.getElementById('case_sensitive').checked,
                exact_match: document.getElementById('exact_match').checked
            };
            
            try {
                const response = await authenticatedFetch(`${API_URL}/api/entities`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Entidad creada exitosamente', 'success');
                    document.getElementById('createForm').reset();
                    loadEntities();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al crear entidad', 'error');
            }
        });

        // Cargar entidades
        async function loadEntities() {
            try {
                const response = await authenticatedFetch(`${API_URL}/api/entities`);
                const result = await response.json();
                
                const container = document.getElementById('entitiesList');
                
                if (!result.success || result.data.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;">No hay entidades creadas</p>';
                    return;
                }
                
                container.innerHTML = result.data.map(entity => `
                    <div class="entity-card" onclick="showEntityDetails('${entity.id}')">
                        <div class="entity-header">
                            <div class="entity-name">${entity.name}</div>
                            <span class="entity-type">${entity.type}</span>
                        </div>
                        <div class="entity-stats">
                            <div class="stat">üìä ${entity._count.mentions} menciones</div>
                            <div class="stat">üö® ${entity._count.alerts} alertas</div>
                        </div>
                        <div class="actions" onclick="event.stopPropagation()">
                            <button class="btn-secondary" onclick="analyzeEntity('${entity.id}')">Analizar</button>
                            <button class="btn-danger" onclick="deleteEntity('${entity.id}')">Eliminar</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('entitiesList').innerHTML = '<p style="color:red;">Error al cargar entidades</p>';
            }
        }

        // Mostrar detalles de entidad
        async function showEntityDetails(entityId) {
            currentEntity = entityId;
            const detailsDiv = document.getElementById('entityDetails');
            const contentDiv = document.getElementById('detailsContent');
            
            detailsDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="loading">Cargando estad√≠sticas...</div>';
            
            try {
                // Obtener estad√≠sticas
                const statsResponse = await authenticatedFetch(`${API_URL}/api/entities/${entityId}/stats`);
                const statsResult = await statsResponse.json();
                
                if (!statsResult.success) {
                    contentDiv.innerHTML = '<p style="color:red;">Error al cargar estad√≠sticas</p>';
                    return;
                }
                
                const stats = statsResult.data;
                const sentimentScore = Math.round((stats.avg_sentiment + 1) * 50); // Convertir -1/1 a 0-100
                const sentimentClass = stats.avg_sentiment > 0.2 ? 'positive' : stats.avg_sentiment < -0.2 ? 'negative' : 'neutral';
                
                // Obtener menciones
                const mentionsResponse = await authenticatedFetch(`${API_URL}/api/entities/${entityId}/mentions?limit=10`);
                const mentionsResult = await mentionsResponse.json();
                
                contentDiv.innerHTML = `
                    <div class="sentiment-score sentiment-${sentimentClass}">
                        ${sentimentScore}/100
                        <div style="font-size:14px;color:#666;font-weight:normal;">Sentimiento General</div>
                    </div>
                    
                    <div class="entity-stats" style="justify-content:center;margin-bottom:20px;">
                        <div class="stat">üìä Total: ${stats.total_mentions}</div>
                        <div class="stat">üìÖ √öltimos 30d: ${stats.recent_mentions}</div>
                    </div>
                    
                    <h3>Distribuci√≥n de Sentimiento</h3>
                    <div class="entity-stats" style="margin-bottom:20px;">
                        <div class="stat">‚úÖ ${stats.sentiment_distribution.POSITIVE} positivos</div>
                        <div class="stat">‚ö†Ô∏è ${stats.sentiment_distribution.NEUTRAL} neutrales</div>
                        <div class="stat">‚ùå ${stats.sentiment_distribution.NEGATIVE} negativos</div>
                    </div>
                    
                    <h3>√öltimas Menciones</h3>
                    <div class="mentions-list">
                        ${mentionsResult.success && mentionsResult.data.mentions.length > 0 
                            ? mentionsResult.data.mentions.map(m => `
                                <div class="mention-item">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                        <strong>${m.scraping_result.title}</strong>
                                        <span class="badge badge-${m.sentiment.toLowerCase()}">${m.sentiment}</span>
                                    </div>
                                    <div style="font-size:12px;color:#666;margin-bottom:10px;">
                                        ${m.scraping_result.domain} ‚Ä¢ ${new Date(m.analyzed_at).toLocaleDateString()}
                                    </div>
                                    <div class="mention-context">${m.context}</div>
                                </div>
                            `).join('')
                            : '<p style="text-align:center;color:#666;">No hay menciones a√∫n</p>'
                        }
                    </div>
                `;
                
            } catch (error) {
                contentDiv.innerHTML = '<p style="color:red;">Error al cargar detalles</p>';
            }
        }

        // Analizar entidad
        async function analyzeEntity(entityId) {
            // Preguntar al usuario los par√°metros
            const days = prompt('¬øCu√°ntos d√≠as atr√°s analizar? (default: 30)', '30');
            const limit = prompt('¬øL√≠mite de noticias a analizar? (default: 100)', '100');
            
            if (!days || !limit) return;
            
            showAlert('üîç Analizando entidad...', 'info');
            
            try {
                const response = await authenticatedFetch(`${API_URL}/api/entities/${entityId}/analyze?days=${days}&limit=${limit}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const { mentions_found, articles_analyzed, domains } = result.data.filters || result.data;
                    showAlert(
                        `‚úÖ An√°lisis completado:\n` +
                        `üìä ${mentions_found} menciones encontradas\n` +
                        `üì∞ ${articles_analyzed} art√≠culos analizados\n` +
                        `üåê ${domains} fuentes seleccionadas`,
                        'success'
                    );
                    if (currentEntity === entityId) {
                        showEntityDetails(entityId);
                    }
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al analizar entidad', 'error');
            }
        }

        // Eliminar entidad
        async function deleteEntity(entityId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta entidad?')) return;
            
            try {
                const response = await authenticatedFetch(`${API_URL}/api/entities/${entityId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Entidad eliminada', 'success');
                    loadEntities();
                    if (currentEntity === entityId) {
                        document.getElementById('entityDetails').style.display = 'none';
                    }
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al eliminar entidad', 'error');
            }
        }

        // Cargar al inicio
        loadEntities();
    </script>
</body>
</html>
